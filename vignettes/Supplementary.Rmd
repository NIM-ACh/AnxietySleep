---
title: "Material suplementario"
output: 
  rmarkdown::html_vignette:
    toc: true
    toc_depth: 2
vignette: >
  %\VignetteIndexEntry{Material suplementario}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  dpi = 300,
  warning = FALSE,
  message = FALSE,
  error = FALSE,
  out.width = "100%"
)
```

# Preparación del espacio de trabajo

Para acceder a los datos del estudio usaremos nuestro paquete `AnxietySleep` y para la manipulación de los datos usaremos el paquete `data.table`.

Si no tienes instalado nuestro paquete, puedes instalarlo usando el siguiente comando:

```r
# install.packages("devtools")
devtools::install_github("NIM-ACh/AnxietySleep", 
                         build_vignettes = TRUE) # Para construir la viñeta 
                                                 # del material suplementario
                                                 
# Posteriormente y para ver esta viñeta puedes usar el siguiente comando:
vignette("Supplementary", package = "AnxietySleep") 
```

Mientras que para instalar los otros paquetes (si no los tienes instalado), puedes usar el siguiente código:

```r
# Paquetes a usar de manera complementaria
.pkgs <- c("data.table", "ggplot2", "ggside", "ggsci",
           "ggpubr", "ggstatsplot", "gtsummary", "gt",
           "magrittr")

# Proceso de instalación
install.packages(.pkgs)
```

Una vez todo instalado, puedes cargar las librerías usando los siguientes comandos:

```{r setup}
library(AnxietySleep) # Paquete del estudio
library(data.table)   # Manipulación de los datos
library(magrittr)     # Para conectar funciones

# Librarías para la generación de gráficos

library(ggplot2)     # Para gráfico principal
library(ggside)      # Distribuciones marginales
library(ggsci)       # Paleta de colores
library(ggpubr)      # Unir los gráficos 2A y 2B
library(ggstatsplot) # Para generar la figura 2

# Librerias para la generación de tablas

library(gt)
library(gtsummary)

```

# Figuras

## Figura 1

<details><summary>Ver código</summary>
```{r}
# Eliminamos dos valores 
remove_outliers <- quote(-c(which.min(pits_global), which.max(pits_global)))

fig1 <- ggplot(data = dataset[i = eval(remove_outliers)],
       aes(x = sqrt(pits_global), 
           y = sqrt(beck_global))) +
  
  # Hacemos el tamaño de los puntos relativo al número de observaciones
  geom_count(shape = 21, color = "black", aes(fill = zona), show.legend = FALSE, alpha = 0.5) +
  
  # Usamos la paleta de colores del 'New England Journal of Medicine'
  scale_color_manual(values = pal_nejm()(2), aesthetics = c("fill", "color")) +
  
  # Generamos la línea de regresión LOESS
  geom_smooth(method = "loess", se = F, aes(col = zona)) +
  
  # Generamos las distribuciones marginales
  geom_xsideboxplot(mapping = aes(y = zona, fill = zona), orientation = "y", 
                    outlier.shape = 21, outlier.alpha = .5, alpha = 0.5) +
  geom_ysideboxplot(mapping = aes(x = zona, fill = zona), orientation = "x", 
                    outlier.shape = 21, outlier.alpha = .5, alpha = 0.5) +
  
  # Y eliminamos las etiquetas de los ejes de estas distribuciones marginales
  scale_xsidey_discrete(guide = guide_none()) +
  scale_ysidex_discrete(guide = guide_none()) +
  
  # Modificamos las etiquetas de los ejes
  labs(x = expression(sqrt("PSQI")),
       y = expression(sqrt("BAI")),
       col = "Confinamiento",
       fill = "Confinamiento") +
  
  # Añadimos un tema para mejorar la estética
  theme_linedraw(base_family = "Times",
                 base_size = 16) +
  
  # La leyenda la dejamos arriba del gráfico y eliminamos las lineas
  # del 'grid' del gráfico
  theme(legend.position = "top",
        panel.grid = element_blank(),
        ggside.panel.scale.x = .15,
        ggside.panel.scale.y = (.15 * 3 / 4))
```
</details>

```{r echo=FALSE, fig.width=8, fig.height=6}
fig1
```



## Figura 2

<details><summary>Ver código</summary>
```{r}
p1 <- ggstatsplot::ggbetweenstats(
  data = dataset, x = sexo, y = beck_global, 
  type = "np", xlab = "", ylab = "BAI", results.subtitle = FALSE,
  palette = "default_nejm", package = "ggsci", k = 0,
  ggtheme = theme_linedraw(base_family = "Times", base_size = 16),
  ggplot.component = list(theme(panel.grid = element_blank())))

p2 <- ggstatsplot::ggbetweenstats(
  data = dataset, x = sexo, y = pits_global, 
  type = "np", xlab = "Sexo", ylab = "PSQI", results.subtitle = FALSE,
  palette = "default_nejm", package = "ggsci", k = 0,
  ggtheme = theme_linedraw(base_family = "Times", base_size = 16),
  ggplot.component = list(theme(panel.grid = element_blank())))

fig2 <- ggpubr::ggarrange(p1, p2, labels = c("A.", "B."), ncol = 1, hjust = 0)
```
</details>

```{r echo=FALSE, fig.width=6, fig.height=8}
fig2
```


# Tabla

## Tabla 1

<details><summary>Ver código</summary>
```{r}
tbl_data <- copy(dataset)[, `:=`(
  sexo = `attr<-`(sexo, "label", "Sexo"),
  beck_global = `attr<-`(beck_global, "label", "Puntaje BAI"),
  pits_global = `attr<-`(pits_global, "label", "Puntaje PSQI")
)]

gtsummary::theme_gtsummary_language("es")


ec_tbl <- gtsummary::tbl_summary(tbl_data[zona == "EC"], 
                       by = cat_edad, 
                       include = c(sexo, beck_global, pits_global)) %>%
  gtsummary::add_p(pvalue_fun = function(x) gtsummary::style_pvalue(x, digits = 3)) %>%
  modify_header(update = gtsummary::all_stat_cols() ~ "**{level} años**<br>N = {n} ({style_percent(p)}%)")

sc_tbl <- gtsummary::tbl_summary(tbl_data[zona == "SC"], 
                       by = cat_edad, 
                       include = c(sexo, beck_global, pits_global)) %>%
  gtsummary::add_p(pvalue_fun = function(x) { gtsummary::style_pvalue(x, digits = 3) }) %>%
  gtsummary::modify_header(update = gtsummary::all_stat_cols() ~ "**{level} años**<br>N = {n} ({style_percent(p)}%)")

tbl <- gtsummary::tbl_stack(tbls = list(ec_tbl, sc_tbl), quiet = TRUE) %>%
  gtsummary::modify_footnote(gtsummary::everything() ~ NA_character_) %>%
  gtsummary::as_gt()

tbl <- tbl %>%
  gt::tab_spanner(label = gt::md("**Grupos etarios**"), columns = paste0("stat_", 1:4)) %>%
  gt::tab_row_group(label = gt::md("**Zona - EC**"), rows = 1:5) %>%
  gt::tab_row_group(label = gt::md("**Zona - SC**"), rows = 6:10)
```
</details>

```{r echo=FALSE}
tbl
```

